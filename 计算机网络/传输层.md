



# 运输层概述
![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/13w46b0IuOdMUs4M.png)

- 网络层主要负责网络寻址，路由选择，将数据发送给目标网络(主机)，但是计算机网络中真正通信的实体是通信两端的进程。
- 为运行在不同主机上的两个进程提供通信服务就是运输层的任务。
## 为什么TCP是面向连接的？

这里说的面向连接并不是指两个节点之间建立一个真正的通信信道，而是一个逻辑上的连接。这里的连接体现在：传输数据之前需要三次挥手确保两节点之间可以正常通信，在传输数据时两个节点需要共同维护这一连接(流量控制，拥塞控制等)，传输数据之后，需要通过四次挥手，确保双方都被告知断开连接，不在进行维护。非面向连接的UDP只管发送或者接受数据，不需要维护两个节点数据传输的状态。


![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/rlaYS0BuSS8Uyaxn.png)

![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/PRXDvem5n9cZsKfL.png)


# 运输层端口号复用与分用

## 为什么使用端口号
1. 计算机的进程在对外提供网络服务时，需要具有一个在该主机中唯一的标识，这样外部网络的消息发送到主机时才能准确的交付给目的进程。
2. 进程具有唯一进程号PID，但是PID在不同的操作系统中格式是不同的，显然不适合当作1中说的唯一标识。
![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/NPQNWI2Z2FXKz99K.png)


## 端口复用和分用

发送方的某些应用进程所发送的不同应用的报文在运输层使用 UDP 协议进行封装

- 这称为 UDP 复用
而另一些应用进程所发送的报文在运输层使用 TCP 协议进行封装

- 这称为 TCP 复用
运输层使用端口号来区分不同的应用进程。

不管是使用运输层的 UDP 协议封装成的 UDP 用户数据报，还是使用运输层的 TCP 协议封装成的 TCP 报文段在网络层都需要使用 IP 协议封装成 IP 数据报（称为 IP 复用）


## UDP和TCP区别
![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/1O3C5NYHDv8k7Kii.png)
1. UDP是无连接协议，提供不可靠传输；TCP是面向连接的协议，提供可靠传输。
2. UDP不需要套接字，TCP需要借助套接字建立连接。
3. UDP支持单播，多播，广播；TCP只支持单播。
4. UDP是面向报文传输的，TCP是面向字节流传输的。

- **面向报文：** 应用层交付给UDP多长的报文，UDP就直接封装成一个UDP报文，并交付给IP层。
- **面向直接流：** 虽然应用程序和TCP的交互是一次一个数据块（大小不等），但TCP把应用程序看成是一连串的无结构的字节流。TCP有一个缓冲，当应用程序传送的数据块太长，TCP就可以把它划分短一些再传送。如果应用程序一次只发送一个字节，TCP也可以等待积累有足够多的字节后再构成报文段发送出去(由TCP具体实现来控制)。

5. UPD报文的首部大小只有8个字节。TCP报文首部至少是20个字节。

# TCP协议
## TCP的首部格式
![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/4A7yLkt4tNMLdEcK.png)


![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/dJ9hj1vwSmB2w0lm.png)

![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/Orz2RIcZ67NEer5U.png)
![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/d6Me5YhZaqWY2vXk.png)

![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/LTSBwQEkvyY04tDk.png)

![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/aCOwiszoPei7FoUs.png)
![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/vxzcAqncbfKThpnx.png)


## TCP的流量控制

**流量控制:** 让发送方的发送效率不要太快，让接受方来得及接受。

TCP协议采用滑动窗口的方式来进行流量控制，发送方和接受方要分别要建立发送窗口和接受窗口。接收方在回复ack时，会根据自己窗口的情况设置rwnd，而发送方会根据改字段动态调整自己的窗口。

下面时例子：

![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/0T80y2boKTuJ9K26.png)

![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/K0VhWacCLn0wDCCB.png)

![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/AsA5AtwEkxBoD68u.png)

![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/wRwJlpIfik0298Xd.png)

![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/ABTIzN96BrU8hF1O.png)

![输入图片说明](https://raw.githubusercontent.com/2985496686/-/master/imgs/%E4%BC%A0%E8%BE%93%E5%B1%82/Y6rfpv9zOkASrPA8.png)

## TCP传输效率

TCP在传输数据时，有可能会发生``糊涂窗口``的情况 。
发送方在发送数据时，应用层可能是以一个字节一个字节的形式，将数据交付给TCP发送缓存，这样TCP很有可能将每一个字节的数据都组装成一个tcp数据报，在组装成IP数据报，发送一个字节的字符却发送了至少41个字节。
TCP使用Nagle算法解决了该问题，该算法规定：若应用进程是逐个字节的将数据放入TCP缓存，那么TCP会先将最先到达的数据封装成TCP数据报发送出去。在发送第二个数据时，需要等待收到第一个数据报的ack，或者缓存数据达到发送窗口的一半或最大报文段长度。

如果接收方












































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































<!--stackedit_data:
eyJoaXN0b3J5IjpbLTIxNDQyMDQyMSwxMDA2MTgwNzg1LDE0NT
E0MjQ5NzEsLTIwNjA4NjIwNjcsMjQ4MzgxNzExLC05NjE1MjM3
MjUsLTEyODM5NTY4MDcsODQwODAzNjI2LC0xNDEyNTY0OTAyLC
0xOTY5OTEzMzU1LDg4NTEwNTU0MiwtMTY5OTUzOTg4MSwtOTkw
MDkyMzE1XX0=
-->